#### はじめに

名前：杉本 雅広（すぎもと まさひろ）

運営中： wgld.org, WebGL総本山

![doxas](doxas.png)

---

#### はじめに

まずは、jsstg へ作品を出展してくださった方、そして連動企画となる本勉強会にご参加くださった方、ありがとうございます。
jsstg 2015 は第二回にあたりますが、今後また第三回も開催できればいいなと思っています。
今後とも jsstg をよろしくお願いします。

---

#### 本日のテーマ

**マルチプラットフォーム WebGL**

jsstg 2015 に出展した「torna-do」の実装を紐解きつつ、モバイル端末でも動作可能な WebGL コンテンツの作成について考えていきます。
モバイル端末ならではのセンサーを使った実装や、いかに描画の負荷を抑えつつリッチな表現を行うかなど、お話できればと思っています。

---

#### torna-do

jsstg 2015 に出展した、果たしてこれはシューティングゲームと呼べるのかという一作。

![torna-do](torna_do.jpg)

---

#### 最初に思い描いていたコンセプト

* モバイル端末でも動作するようにしたい
* モバイル端末ならではのセンサー利用したい
* 負荷を少しでも抑えるため頂点数は少なくしたい
* でも見た目はちょっとくらいかっこよくしたい

---

#### 最初に思い描いていたコンセプト

* モバイル端末でも動作するようにしたい
* モバイル端末ならではのセンサー利用したい
* 負荷を少しでも抑えるため頂点数は少なくしたい
* でも見た目はちょっとくらいかっこよくしたい
--下のふたつは相反する部分があるので悩ましいところ--

---

#### モバイルならではのセンサー

PC には無い、モバイル端末ならではのセンサーを使った実装をしたかった。
真っ先に思いついたのが「タッチ」と「ジャイロ」のふたつ。
タッチを使うなら*マルチタッチ*にしたかったが、なんとなくジャイロのほうが面白そうだったのでジャイロセンサーを用いた移動形式に。

---

#### ジャイロセンサーとは

ジャイロセンサーは、モバイル端末の「傾き」を計測するセンサーです。
javascript から参照できるセンサーとしては、最も初期から対応が進められてきたものなので、Android や iOS で比較的データを取りやすいセンサーだと思います。
ちなみに、どのセンサーの情報が取れるのかは OS ではなくブラウザの実装によります。

---

#### ジャイロセンサーの入力を取得

ジャイロセンサーの値は、端末の傾きを X Y Z の三軸で取った結果として取得できます。
正式な表記が X Y Z ではなく alpha、beta、gamma なのでちょっと紛らわしいです。
--X = beta, Y = gamma, Z = alpha--

---

#### ジャイロセンサーの入力を取得

![device orientation](orientation.jpg)

---

#### ゲームにどう組み込んだか

torna-do の場合は、alpha の情報は利用せずに、beta と gamma の情報だけを自機キャラクターの移動に利用してます。
動作環境が PC の場合は、キー入力により一定の慣性が付くようにしました。
キー入力で慣性が付くようにしたのには理由があり、モバイル端末での実行時に比べ*キー入力のほうが圧倒的に操作しやすい*ことが予想できたので、PC 側では少し難易度を上げたかったため。

---

#### マルチプラットフォームな移動処理実装

キャラクターの移動処理は、モバイル端末では、端末の傾きに応じて「キャラクターに適用される慣性ベクトルを増減させる」方針とした。
素直にセンサーの値をそのまま移動に適用してしまうと、移動が速くなりすぎたり、ブレが大きく制御しにくいと感じる傾向があったためにこのような方針にしました。
PC の場合も、この慣性ベクトルをキー入力に応じて一定数増減させるようにしてます。

---

#### 慣性ベクトルの減衰

慣性ベクトルに対しては、ループのたびに`0.95`を乗算する仕組みになっていて、これによって自然な減衰のような効果が得られるようになります。
非常に簡単な乗算処理を毎ループ行うだけで、まるで水中を漂っているかのようなふわふわとした動きが実現できます。
計算の負荷も高くありませんし、手軽に使えるのでおすすめです。

---

#### モバイル端末を動作環境に含める場合の難点

モバイル端末での動作を踏まえた場合に、難点になりそうな部分がいくつかあったので紹介します。

---

#### イベントの発火回数問題

ジャイロセンサーを用いる場合、`deviceorientation`という名前のイベントに`addEventListener`で関数を登録します。
実際にやってみるとわかりますが、ジャイロセンサーは非常に精度が高く更新頻度も多いです。
ほとんど振動の無い部屋で、テーブルの上に置いて放置するくらいのことをしないと、常にイベントが発火し続けます（機種によるのかもしれませんが）。

---

#### イベントの発火回数問題

このことから、描画に関連するイベントを`addEventListener`と紐付けたり、コストの高い計算をイベント発火のたびに行ったりすると、*非常に大きな負荷*になる可能性があります。
やり方はいろいろ考えられますが、適当にイベントを間引くような仕組みを入れたり、イベント発火によって実行される処理の内容をよく吟味する必要があると思います。

---

#### イベントの発火回数問題

たとえば、イベント発火のたびに「数値を加算」するような処理を仕込んでいると、ループが回るよりも高い頻度でイベントが発火してしまった際に、想定していたよりも加算処理が多く発生してしまう可能性がありますよね。
ループの動きと連動したフラグを使って、フラグが既に立っていたらイベント発火時の処理を場合により`return`するなど、なにかしらの工夫が必要な場面も考えられるのかなと思いました。

---

#### スクリーンの大きさやロックの問題

現在策定中の <a href="http://www.w3.org/TR/screen-orientation/">The Screen Orientation API</a> を利用すると、画面の向きをロックすることができ、縦長や横長の画面に最適化された設計ができるようになります。
現状は、かなりブラウザにより混沌としている感じなので、torna-do には画面のロック機能は入れていません。
傾き具合を移動のパラメータとして利用している本作では、本来であればロック機能はぜひとも欲しかったんですが残念。

---

#### スクリーンの大きさやロックの問題

また、スクリーンが横長でも縦長でも対応できるように設計が可能なのであれば話は別ですが、torna-do の場合、縦長や横長になると敵キャラクターが出現してから、それを目視できるようになるまでの間に時間差が生まれてしまいます。
torna-do では、苦肉の策として canvas のサイズを正方形に強制してしまうようにしました。画面のロックが javascript から制御できるようになれば、もっといろいろな発想が行えるようになっていくと思いますので、今後に期待という感じ。
--VR コンテンツを作るのにも必ず必要ですよね。--

---

#### リソース毎回ダウンロードはつらいよ問題

モバイル端末で結構根深い問題だなと感じるのが、リソースのダウンロードに掛かる時間。
torna-do では 4.5MB ほどの容量を持つ BGM 用の mp3 ファイルを使っているが、有線で接続している PC と比較すると時間的にも、また通信容量制限の兼ね合いからも、やっぱりつらいなあという印象。
このあたりも、インフラや通信事業者の今後に期待？

---

#### プロシージャルにできるものを見極める

ページを開くたびにダウンロードが発生してしまうことを避ける意味では、可能な範囲で、プロシージャルに生成できるものはプロシージャルに、という考え方もあります。
プロシージャルにやってしまうことで逆に高負荷になったり、時間が掛かってしまうものも考えられるので、そのあたりはうまく調整することが必要になりそう。

---

#### プロシージャルにできるものを見極める

プロシージャルに生成できるものといえば、代表的なところでは以下のようなもの。

* ノイズテクスチャ（WebGLでやると速い）
* キャプションなどの文字列（canvas2D）
* 効果音や BGM（Web Audio API や Web MIDI API）
* モデルのメッシュデータ（幾何学的なものなら）

---

#### リッチな表現の工夫

見た目をリッチにするためには、やり方はいろいろ考えられるものの、王道的なものがいくつかあります。
ゲームやコンテンツの雰囲気にもよるので一概には言えませんが、紹介します。

---

#### 光を上手に表現する

全体に暗いイメージのシーンでは特に有用な方法として、光の表現をうまく行うことが挙げられます。

画像

---

#### 光とブラーと加算合成と

光の表現に欠かせない要素として、大きなところでは*ブラー*と*加算合成*のふたつがあります。
ブラーとは「ぼかし」のことですね。ガウシアンブラーなどが有名。
加算合成とは、色を乗算によって処理するのではなく、加算によって合成処理する方法です。

---

#### 光とブラーと加算合成と

乗算と加算の違い。

画像

---

#### シェーダとブレンドファクタ

WebGL ではシェーダを用いて色を自在に処理することができますが、ブレンドに関する設定は javascript 側で行います。
torna-do の場合、ブレンドファクタの設定で加算合成とアルファ値による半透明処理を同時に行えるように設定しています。
実際にアルファ値を操作しているのは、シェーダです。

---

####

---

####

---

####

---

####

---

####

---

####

---

####

---

####



---

### agenda

WebGLな話

* プロシージャルにできるものはそうする
* オフスクリーンレンダリングを活用した方法
* ガウシアンブラー
* 加算合成



